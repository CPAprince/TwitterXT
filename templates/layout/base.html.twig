<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">

        <title>
            {% block title %}TwitterXT{% endblock %}
        </title>

        <link rel="icon" type="image/x-icon" href="/favicon.ico">

        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
              rel="stylesheet"
              integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB"
              crossorigin="anonymous">

        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" rel="stylesheet">
        <link href="{{ asset('css/style.css') }}" rel="stylesheet">

        {% block stylesheets %}{% endblock %}
        <style>
            .auth-guest-only,
            .auth-user-only {
                display: none !important;
            }

            body.is-authenticated .auth-user-only {
                display: block !important;
            }

            body.is-guest .auth-guest-only {
                display: block !important;
            }
        </style>
    </head>

    <body>
        <main>
            {% include 'component/nav/_bar.html.twig' %}

            <div class="container-fluid py-4">
                <div class="row">
                    <div class="col-md-3 d-none d-md-block"></div>

                    <div class="col-12 col-md-9">
                        {% block content %}{% endblock %}
                    </div>
                </div>
            </div>
        </main>

        {% block footer %}{% endblock %}

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
                integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
                crossorigin="anonymous"></script>

        <script>
            // Centralized route management
            // Helper function to build routes with parameters
            window.buildRoute = function(routePattern, params) {
                let route = routePattern;
                for (const [key, value] of Object.entries(params)) {
                    route = route.replace(`{${key}}`, encodeURIComponent(value));
                }
                return route;
            };

            // All API routes - available on all pages
            window.routes = {
                // Existing routes (from registration.html.twig)
                createUser: '{{ path('api_create_user') }}',
                login: '{{ path('api_login_check') }}',
                createProfile: '{{ path('api_create_profile') }}',
                registerUser: '{{ path('api_registration') }}',
                successRedirect: '{{ path('homepage') }}',

                // New routes
                tokenRefresh: '/api/token/refresh', // Bundle route, no named route available
                updateProfile: '{{ path('api_update_profile', {userId: 'PLACEHOLDER'}) }}'.replace('PLACEHOLDER', '{userId}'),
                updateTweet: '{{ path('api_update_tweet', {tweetId: 'PLACEHOLDER'}) }}'.replace('PLACEHOLDER', '{tweetId}'),
                getProfile: '{{ path('api_get_profile', {userId: 'PLACEHOLDER'}) }}'.replace('PLACEHOLDER', '{userId}'),
                getTweets: '{{ path('tweets_get_all') }}',
                registration: '{{ path('registration') }}',
                profilePage: '{{ path('profile_page', {userId: 'PLACEHOLDER'}) }}'.replace('PLACEHOLDER', '{userId}'),
                logout: '{{ path('api_tokens_logout') }}',
            };
        </script>

        <script src="{{ asset('js/api.js') }}"></script>
        <script src="{{ asset('js/auth.js') }}"></script>
        <script src="{{ asset('js/char-counter.js') }}"></script>
        <script>
            // Set profile link dynamically
            async function updateProfileLinks() {
                // Find all profile links (there are two - mobile and desktop)
                const profileLinks = document.querySelectorAll('a[id="nav-profile-link"]');

                if (profileLinks.length === 0) {
                    console.warn('Profile link not found');
                    return;
                }

                // Check if Auth is available
                if (!window.Auth || !window.Api) {
                    console.warn('Auth or Api not available');
                    // Retry after a short delay if scripts aren't loaded yet
                    setTimeout(updateProfileLinks, 100);
                    return;
                }

                try {
                    const userId = await Auth.getCurrentUserId();
                    console.log('Current userId:', userId); // Debug log

                    profileLinks.forEach(profileLink => {
                        if (userId) {
                            profileLink.href = `/p/${userId}`;
                            profileLink.style.opacity = "1";
                            profileLink.style.cursor = "pointer";
                            profileLink.style.pointerEvents = "auto";
                        } else {
                            profileLink.href = "#";
                            profileLink.style.opacity = "0.5";
                            profileLink.style.cursor = "not-allowed";
                            profileLink.style.pointerEvents = "none";
                        }
                    });
                } catch (error) {
                    console.error('Error updating profile links:', error);
                }
            }

            // Make updateProfileLinks available globally so it can be called after registration
            window.updateProfileLinks = updateProfileLinks;

            // Try to update immediately if DOM is already loaded
            if (document.readyState === 'loading') {
                document.addEventListener("DOMContentLoaded", () => {
                    // Small delay to ensure all scripts are loaded
                    setTimeout(updateProfileLinks, 50);
                });
            } else {
                // DOM is already loaded
                setTimeout(updateProfileLinks, 50);
            }
        </script>

        <script src="{{ asset('js/realtime.js') }}"></script>

        {% block javascripts %}{% endblock %}
    </body>
</html>
