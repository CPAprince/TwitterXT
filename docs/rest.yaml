openapi: 3.0.3
info:
    title: Twitter Clone â€“ Auth, Profile, Tweet, Like API
    version: 1.0.0
    description: |-
        REST API specification derived from domain use cases:
        
        - Tokens (issue, revoke, refresh)
        - Users (register)
        - Profiles (system create, read, update)
        - Tweets / Feeds (create, read single, list user feed, list global feed, update)
        - Likes (toggle)
        
        ## Content-Type
        Request bodies are expected as `application/json`.

        ## Errors
        Domain/application errors (handled by `ExceptionSubscriber`) are usually returned as:

        ```json
        {"error": {"code": "...", "message": "..."}}
        ```

        Validation errors produced by `assert/assert` may be returned as:

        ```json
        {"errors": [{"field": "...", "message": "..."}]}
        ```

servers:
    -   url: /api
tags:
    -   name: Health
    -   name: Auth
    -   name: Users
    -   name: Profiles
    -   name: Tweets
    -   name: Likes

paths:
    /health:
        get:
            tags: [ Health ]
            summary: Health check
            operationId: healthCheck
            responses:
                "200":
                    description: OK
                    content:
                        application/json:
                            schema: { $ref: "#/components/schemas/HealthResponse" }
                "500": { $ref: "#/components/responses/InternalServerError" }
    
    /users:
        post:
            tags: [ Users ]
            summary: Register user
            operationId: createUser
            requestBody:
                required: true
                content:
                    application/json:
                        schema: { $ref: "#/components/schemas/CreateUserRequest" }
                        examples:
                            example:
                                value:
                                    email: john.doe@example.com
                                    password: "Test12345!"
            responses:
                "201":
                    description: User created
                    content:
                        application/json:
                            schema: { $ref: "#/components/schemas/CreateUserResponse" }
                            examples:
                                example:
                                    value: { id: "3fa85f64-5717-4562-b3fc-2c963f66afa6" }
                "409":
                    description: User already exists
                    content:
                        application/json:
                            schema: { $ref: "#/components/schemas/ErrorResponse" }
                            examples:
                                userAlreadyExists:
                                    value:
                                        error: { code: USER_ALREADY_EXISTS, message: "A user with this email already exists" }
                "422": { $ref: "#/components/responses/UnprocessableEntity" }
                "500": { $ref: "#/components/responses/InternalServerError" }
    
    /token:
        post:
            tags: [ Auth ]
            summary: Login (issue JWT + refresh token)
            operationId: login
            requestBody:
                required: true
                content:
                    application/json:
                        schema: { $ref: "#/components/schemas/LoginRequest" }
                        examples:
                            example:
                                value: { email: john.doe@example.com, password: "Test12345!" }
            responses:
                "200":
                    description: Tokens issued
                    content:
                        application/json:
                            schema: { $ref: "#/components/schemas/AuthTokensResponse" }
                            examples:
                                example:
                                    value:
                                        token: "jwt-access-token"
                                        refresh_token: "jwt-refresh-token"
                "401":
                    description: Invalid credentials
                    content:
                        application/json:
                            schema:
                                oneOf:
                                    -   $ref: "#/components/schemas/AuthFailureResponse"
                                    -   $ref: "#/components/schemas/ErrorResponse"
                            examples:
                                invalidCredentials:
                                    value: { code: 401, message: "Invalid credentials." }
                "500": { $ref: "#/components/responses/InternalServerError" }
    
    /token/refresh:
        post:
            tags: [ Auth ]
            summary: Refresh access token
            description: Uses Gesdinet JWT Refresh Token Bundle. Request parameter name is `refresh_token`.
            operationId: refreshToken
            requestBody:
                required: true
                content:
                    application/json:
                        schema: { $ref: "#/components/schemas/RefreshTokenRequest" }
                        examples:
                            example:
                                value: { refresh_token: "jwt-refresh-token" }
            responses:
                "200":
                    description: Token refreshed
                    content:
                        application/json:
                            schema: { $ref: "#/components/schemas/AuthTokensResponse" }
                            examples:
                                example:
                                    value:
                                        token: "new-jwt-access-token"
                                        refresh_token: "jwt-refresh-token"
                "401":
                    description: Invalid or expired refresh token
                    content:
                        application/json:
                            schema:
                                oneOf:
                                    -   $ref: "#/components/schemas/AuthFailureResponse"
                                    -   $ref: "#/components/schemas/ErrorResponse"
                            examples:
                                invalidRefreshToken:
                                    value: { code: 401, message: "Invalid refresh token." }
                "500": { $ref: "#/components/responses/InternalServerError" }
    
    /tokens:
        delete:
            tags: [ Auth ]
            summary: Logout (revoke refresh token)
            operationId: logout
            security: [ { bearerAuth: [ ] } ]
            requestBody:
                required: true
                content:
                    application/json:
                        schema: { $ref: "#/components/schemas/LogoutRequest" }
                        examples:
                            example:
                                value: { refreshToken: "jwt-refresh-token" }
            responses:
                "204":
                    description: Logged out
                "401": { $ref: "#/components/responses/Unauthorized" }
                "422":
                    description: Validation failed
                    content:
                        application/json:
                            schema: { $ref: "#/components/schemas/ErrorResponse" }
                            examples:
                                validationError:
                                    value:
                                        error: { code: VALIDATION_ERROR, message: "Validation failed." }
                "500": { $ref: "#/components/responses/InternalServerError" }
    
    /profiles:
        post:
            tags: [ Profiles ]
            summary: Create profile
            description: Used by the frontend after registration.
            operationId: createProfile
            security: [ { bearerAuth: [ ] } ]
            requestBody:
                required: true
                content:
                    application/json:
                        schema: { $ref: "#/components/schemas/CreateProfileRequest" }
                        examples:
                            example:
                                value:
                                    userId: "3fa85f64-5717-4562-b3fc-2c963f66afa6"
                                    name: "John Doe"
                                    bio: "Hello Twitter!"
            responses:
                "201":
                    description: Profile created (no body)
                "401": { $ref: "#/components/responses/Unauthorized" }
                "404":
                    description: User not found
                    content:
                        application/json:
                            schema: { $ref: "#/components/schemas/ErrorResponse" }
                            examples:
                                userNotFound:
                                    value:
                                        error: { code: USER_NOT_FOUND, message: "The user with this ID was not found" }
                "409":
                    description: Profile already exists
                    content:
                        application/json:
                            schema: { $ref: "#/components/schemas/ErrorResponse" }
                            examples:
                                profileAlreadyExists:
                                    value:
                                        error: { code: PROFILE_ALREADY_EXISTS, message: "A profile with this user already exists" }
                "422": { $ref: "#/components/responses/UnprocessableEntity" }
                "500": { $ref: "#/components/responses/InternalServerError" }
    
    /profiles/{userId}:
        get:
            tags: [ Profiles ]
            summary: Get profile
            operationId: getProfile
            parameters:
                -   $ref: "#/components/parameters/UserId"
            responses:
                "200":
                    description: Profile
                    content:
                        application/json:
                            schema: { $ref: "#/components/schemas/GetProfileResponse" }
                "404":
                    description: Profile not found
                    content:
                        application/json:
                            schema: { $ref: "#/components/schemas/ErrorResponse" }
                            examples:
                                profileNotFound:
                                    value:
                                        error: { code: PROFILE_NOT_FOUND, message: "The profile with this user ID was not found" }
                "422": { $ref: "#/components/responses/UnprocessableEntity" }
                "500": { $ref: "#/components/responses/InternalServerError" }
        
        patch:
            tags: [ Profiles ]
            summary: Update profile
            description: Only the authenticated user can update their own profile (userId in path must match JWT subject).
            operationId: updateProfile
            security: [ { bearerAuth: [ ] } ]
            parameters:
                -   $ref: "#/components/parameters/UserId"
            requestBody:
                required: true
                content:
                    application/json:
                        schema: { $ref: "#/components/schemas/UpdateProfileRequest" }
                        examples:
                            updateName:
                                value: { name: "New Name" }
                            updateBio:
                                value: { bio: "New bio" }
            responses:
                "200":
                    description: Profile updated
                    content:
                        application/json:
                            schema: { $ref: "#/components/schemas/UpdateProfileResponse" }
                "401": { $ref: "#/components/responses/Unauthorized" }
                "404":
                    description: Profile not found
                    content:
                        application/json:
                            schema: { $ref: "#/components/schemas/ErrorResponse" }
                            examples:
                                profileNotFound:
                                    value:
                                        error: { code: PROFILE_NOT_FOUND, message: "The profile with this user ID was not found" }
                "422":
                    description: Validation failed
                    content:
                        application/json:
                            schema:
                                oneOf:
                                    -   $ref: "#/components/schemas/ErrorResponse"
                                    -   $ref: "#/components/schemas/ValidationErrorsResponse"
                            examples:
                                emptyPatch:
                                    value:
                                        error:
                                            code: VALIDATION_ERROR
                                            message: "At least one field (name or bio) must be provided"
                "500": { $ref: "#/components/responses/InternalServerError" }
    
    /tweets:
        get:
            tags: [ Tweets ]
            summary: Get tweets feed
            operationId: getTweets
            parameters:
                -   $ref: "#/components/parameters/Limit"
                -   $ref: "#/components/parameters/Page"
            responses:
                "200":
                    description: Tweets
                    content:
                        application/json:
                            schema: { $ref: "#/components/schemas/GetTweetsResponse" }
                "500": { $ref: "#/components/responses/InternalServerError" }
        
        post:
            tags: [ Tweets ]
            summary: Create tweet
            operationId: createTweet
            security: [ { bearerAuth: [ ] } ]
            requestBody:
                required: true
                content:
                    application/json:
                        schema: { $ref: "#/components/schemas/CreateTweetRequest" }
                        examples:
                            example:
                                value: { content: "Hello world!" }
            responses:
                "201":
                    description: Tweet created
                    content:
                        application/json:
                            schema: { $ref: "#/components/schemas/CreateTweetResponse" }
                "401": { $ref: "#/components/responses/Unauthorized" }
                "422": { $ref: "#/components/responses/UnprocessableEntity" }
                "500": { $ref: "#/components/responses/InternalServerError" }
    
    /tweets/{tweetId}:
        get:
            tags: [ Tweets ]
            summary: Get tweet
            operationId: getTweet
            parameters:
                -   $ref: "#/components/parameters/TweetId"
            responses:
                "200":
                    description: Tweet
                    content:
                        application/json:
                            schema: { $ref: "#/components/schemas/TweetView" }
                "404":
                    description: Tweet not found
                    content:
                        application/json:
                            schema: { $ref: "#/components/schemas/ErrorResponse" }
                            examples:
                                tweetNotFound:
                                    value:
                                        error: { code: TWEET_NOT_FOUND, message: "The tweet with this ID was not found" }
                "422": { $ref: "#/components/responses/UnprocessableEntity" }
                "500": { $ref: "#/components/responses/InternalServerError" }
        
        patch:
            tags: [ Tweets ]
            summary: Update tweet
            operationId: updateTweet
            security: [ { bearerAuth: [ ] } ]
            parameters:
                -   $ref: "#/components/parameters/TweetId"
            requestBody:
                required: true
                content:
                    application/json:
                        schema: { $ref: "#/components/schemas/UpdateTweetRequest" }
                        examples:
                            example:
                                value: { content: "Updated tweet content" }
            responses:
                "200":
                    description: Tweet updated
                    content:
                        application/json:
                            schema: { $ref: "#/components/schemas/UpdateTweetResponse" }
                "401": { $ref: "#/components/responses/Unauthorized" }
                "403":
                    description: Access denied
                    content:
                        application/json:
                            schema: { $ref: "#/components/schemas/ErrorResponse" }
                            examples:
                                accessDenied:
                                    value:
                                        error: { code: ACCESS_DENIED, message: "You are not allowed to access this tweet" }
                "404":
                    description: Tweet not found
                    content:
                        application/json:
                            schema: { $ref: "#/components/schemas/ErrorResponse" }
                            examples:
                                tweetNotFound:
                                    value:
                                        error: { code: TWEET_NOT_FOUND, message: "The tweet with this ID was not found" }
                "422": { $ref: "#/components/responses/UnprocessableEntity" }
                "500": { $ref: "#/components/responses/InternalServerError" }
    
    /profiles/{userId}/tweets:
        get:
            tags: [ Tweets ]
            summary: Get tweets by user
            operationId: getUserTweets
            parameters:
                -   $ref: "#/components/parameters/UserId"
                -   $ref: "#/components/parameters/Limit"
                -   $ref: "#/components/parameters/Page"
            responses:
                "200":
                    description: Tweets by user (array)
                    content:
                        application/json:
                            schema:
                                type: array
                                items: { $ref: "#/components/schemas/TweetView" }
                "204":
                    description: No tweets for this user
                "500": { $ref: "#/components/responses/InternalServerError" }
    
    /tweets/{tweetId}/likes/toggle:
        post:
            tags: [ Likes ]
            summary: Toggle like
            operationId: toggleLike
            security: [ { bearerAuth: [ ] } ]
            parameters:
                -   $ref: "#/components/parameters/TweetId"
            responses:
                "200":
                    description: Like toggled
                    content:
                        application/json:
                            schema: { $ref: "#/components/schemas/LikeToggleResponse" }
                            examples:
                                liked:
                                    value: { liked: true }
                                unliked:
                                    value: { liked: false }
                "401": { $ref: "#/components/responses/Unauthorized" }
                "409":
                    description: Conflict (race condition while liking)
                    content:
                        application/json:
                            schema: { $ref: "#/components/schemas/ErrorResponse" }
                            examples:
                                likeAlreadyExists:
                                    value:
                                        error: { code: LIKE_ALREADY_EXISTS, message: "The tweet has already been liked by this user" }
                "500": { $ref: "#/components/responses/InternalServerError" }

components:
    securitySchemes:
        bearerAuth:
            type: http
            scheme: bearer
            bearerFormat: JWT
    
    parameters:
        UserId:
            in: path
            name: userId
            required: true
            schema:
                type: string
                format: uuid
            description: User identifier (UUID)
        
        TweetId:
            in: path
            name: tweetId
            required: true
            schema:
                type: string
                format: uuid
            description: Tweet identifier (UUID)
        
        Limit:
            in: query
            name: limit
            required: false
            schema:
                type: integer
                minimum: 0
                default: 0
            description: Max number of items to return (0 means implementation default)
        
        Page:
            in: query
            name: page
            required: false
            schema:
                type: integer
                minimum: 0
                default: 0
            description: Page index (0-based)
    
    responses:
        Unauthorized:
            description: Unauthorized
            content:
                application/json:
                    schema: { $ref: "#/components/schemas/ErrorResponse" }
                    examples:
                        unauthorized:
                            value:
                                error: { code: AUTH_UNAUTHORIZED, message: "Unauthorized." }
        
        UnprocessableEntity:
            description: Validation failed
            content:
                application/json:
                    schema:
                        oneOf:
                            -   $ref: "#/components/schemas/ErrorResponse"
                            -   $ref: "#/components/schemas/ValidationErrorsResponse"
                    examples:
                        validationError:
                            value:
                                error: { code: VALIDATION_ERROR, message: "Validation failed." }
                        fieldErrors:
                            value:
                                errors:
                                    -   field: email
                                        message: "The provided email address is invalid"
        
        InternalServerError:
            description: Internal server error
            content:
                application/json:
                    schema: { $ref: "#/components/schemas/ErrorResponse" }
                    examples:
                        internal:
                            value:
                                error: { code: INTERNAL_SERVER_ERROR, message: "An unexpected error occurred. Please try again later" }
    
    schemas:
        ErrorCode:
            type: string
            description: Domain/application error code
            enum:
                - BAD_REQUEST
                - AUTH_UNAUTHORIZED
                - AUTH_TOKEN_INVALID
                - VALIDATION_ERROR
                - INVALID_EMAIL
                - INVALID_PASSWORD
                - USER_ALREADY_EXISTS
                - USER_NOT_FOUND
                - PROFILE_NOT_FOUND
                - PROFILE_ALREADY_EXISTS
                - TWEET_NOT_FOUND
                - ACCESS_DENIED
                - LIKE_ALREADY_EXISTS
                - INTERNAL_SERVER_ERROR
                - HTTP_ERROR
        
        ErrorResponse:
            type: object
            additionalProperties: false
            required: [ error ]
            properties:
                error:
                    type: object
                    additionalProperties: false
                    required: [ code, message ]
                    properties:
                        code: { $ref: "#/components/schemas/ErrorCode" }
                        message:
                            type: string
                            description: Human-readable error message
        
        FieldError:
            type: object
            additionalProperties: false
            required: [ field, message ]
            properties:
                field: { type: string }
                message: { type: string }
        
        ValidationErrorsResponse:
            type: object
            additionalProperties: false
            required: [ errors ]
            properties:
                errors:
                    description: |-
                        Validation errors produced by `assert/assert`.
                        
                        Note: depending on the thrown assertion type, the backend may return either a single object
                        (`{field, message}`) or an array of such objects.
                    oneOf:
                        -   $ref: "#/components/schemas/FieldError"
                        -   type: array
                            items: { $ref: "#/components/schemas/FieldError" }
        
        HealthResponse:
            type: object
            additionalProperties: false
            required: [ status, checkedAt ]
            properties:
                status: { type: string, enum: [ ok ] }
                checkedAt: { type: string, format: date-time }
        
        LoginRequest:
            type: object
            additionalProperties: false
            required: [ email, password ]
            properties:
                email: { type: string, format: email }
                password: { type: string, minLength: 1 }
        
        RefreshTokenRequest:
            type: object
            additionalProperties: false
            required: [ refresh_token ]
            properties:
                refresh_token: { type: string }
        
        LogoutRequest:
            type: object
            additionalProperties: false
            required: [ refreshToken ]
            properties:
                refreshToken: { type: string }
        
        AuthTokensResponse:
            type: object
            additionalProperties: false
            required: [ token ]
            properties:
                token:
                    type: string
                    description: Access token (JWT)
                refresh_token:
                    type: string
                    description: Refresh token (may be omitted by server on refresh)
        
        AuthFailureResponse:
            type: object
            additionalProperties: false
            required: [ code, message ]
            properties:
                code: { type: integer }
                message: { type: string }
        
        CreateUserRequest:
            type: object
            additionalProperties: false
            required: [ email, password ]
            properties:
                email: { type: string, format: email }
                password:
                    type: string
                    minLength: 8
                    description: Must contain upper, lower, digit, and special character
        
        CreateUserResponse:
            type: object
            additionalProperties: false
            required: [ id ]
            properties:
                id: { type: string, format: uuid }
        
        CreateProfileRequest:
            type: object
            additionalProperties: false
            required: [ userId, name ]
            properties:
                userId: { type: string, format: uuid }
                name: { type: string }
                bio:
                    type: string
                    nullable: true
        
        GetProfileResponse:
            type: object
            additionalProperties: false
            required: [ userId, name, bio, createdAt, updatedAt ]
            properties:
                userId: { type: string, format: uuid }
                name: { type: string }
                bio:
                    type: string
                    nullable: true
                createdAt: { type: string, format: date-time }
                updatedAt: { type: string, format: date-time }
        
        UpdateProfileRequest:
            type: object
            additionalProperties: false
            properties:
                name: { type: string }
                bio:
                    type: string
                    nullable: true
        
        UpdateProfileResponse:
            type: object
            additionalProperties: false
            required: [ userId, name, bio, updatedAt ]
            properties:
                userId: { type: string, format: uuid }
                name: { type: string }
                bio:
                    type: string
                    nullable: true
                updatedAt: { type: string, format: date-time }
        
        CreateTweetRequest:
            type: object
            additionalProperties: false
            required: [ content ]
            properties:
                content: { type: string }
        
        CreateTweetResponse:
            type: object
            additionalProperties: false
            required: [ tweetId, createdAt, updatedAt ]
            properties:
                tweetId: { type: string, format: uuid }
                createdAt: { type: string, format: date-time }
                updatedAt: { type: string, format: date-time }
        
        TweetAuthor:
            type: object
            additionalProperties: false
            required: [ id, name ]
            properties:
                id: { type: string, format: uuid }
                name: { type: string }
        
        TweetView:
            type: object
            additionalProperties: false
            required: [ id, content, createdAt, updatedAt, author, likesCount ]
            properties:
                id: { type: string, format: uuid }
                content: { type: string }
                createdAt: { type: string, format: date-time }
                updatedAt: { type: string, format: date-time }
                author: { $ref: "#/components/schemas/TweetAuthor" }
                likesCount:
                    type: integer
                    minimum: 0
        
        GetTweetsResponse:
            type: object
            additionalProperties: false
            required: [ tweets ]
            properties:
                tweets:
                    type: array
                    items: { $ref: "#/components/schemas/TweetView" }
        
        UpdateTweetRequest:
            type: object
            additionalProperties: false
            required: [ content ]
            properties:
                content: { type: string }
        
        UpdateTweetResponse:
            type: object
            additionalProperties: false
            required: [ content, updatedAt ]
            properties:
                content: { type: string }
                updatedAt: { type: string, format: date-time }
        
        LikeToggleResponse:
            type: object
            additionalProperties: false
            required: [ liked ]
            properties:
                liked: { type: boolean }

